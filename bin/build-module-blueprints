#!/bin/bash
SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
source "$SCRIPT_DIR/../.env"

doDownloadSheet () {
  sFileName="$1"
  sURL="$2"
  curl -s -L --max-redir 5 "$sURL" --output "$SCRIPT_DIR/$sFileName.csv"
  if [ ! -f "$SCRIPT_DIR/$sFileName.csv" ]
  then
    echo "FILE NOT DOWNLOADED"
    echo "url: $sURL"
    echo "file: $SCRIPT_DIR/$sFileName.csv"
    exit 3
  fi
}

doTransformDataTypes () {
  MODULE="$1"
  BP_SUB="$2"
  THIS_TYPE="$3"
  URL="$4"
  BP_PATH="$SCRIPT_DIR/../src/modules/$MODULE/blueprints/$BP_SUB/$THIS_TYPE"
  echo "downloading/building $MODULE::$THIS_TYPE"
  mkdir -p "$BP_PATH"
  rm "$BP_PATH"/*.json
  doDownloadSheet "$MODULE-$THIS_TYPE" "$URL"
  node transform-data.js "$MODULE-$THIS_TYPE.csv" "$BP_PATH"
  rm "$MODULE-$THIS_TYPE.csv"
}

doProcessModuleData () {
  MODULE="$1"
  echo "building module $MODULE blueprints"
  cd "$SCRIPT_DIR" || exit 1
  doTransformDataTypes "$MODULE" types weapon-types "$URL_SHEET_CLASSIC_WEAPON_TYPES"
  doTransformDataTypes "$MODULE" types armor-types "$URL_SHEET_CLASSIC_ARMOR_TYPES"
  doTransformDataTypes "$MODULE" types ammo-types "$URL_SHEET_CLASSIC_AMMO_TYPES"
  doTransformDataTypes "$MODULE" types gear-types "$URL_SHEET_CLASSIC_GEAR_TYPES"
  doTransformDataTypes "$MODULE" types shield-types "$URL_SHEET_CLASSIC_SHIELD_TYPES"
  doTransformDataTypes "$MODULE" items weapons "$URL_SHEET_CLASSIC_WEAPONS"
  doTransformDataTypes "$MODULE" items armors "$URL_SHEET_CLASSIC_ARMORS"
  doTransformDataTypes "$MODULE" items ammo "$URL_SHEET_CLASSIC_AMMUNITIONS"
  doTransformDataTypes "$MODULE" items gear "$URL_SHEET_CLASSIC_GEAR"
  doTransformDataTypes "$MODULE" items shields "$URL_SHEET_CLASSIC_SHIELDS"
  doTransformDataTypes "$MODULE" creatures monsters "$URL_SHEET_CLASSIC_MONSTERS"
  echo "done with data transform, returning to previous directory"
  cd - || exit 1
}

processAllModules () {
  cd "$SCRIPT_DIR/../src/modules" || exit 1
  for sModuleName in *
  do
    doProcessModuleData "$sModuleName"
  done
  cd - || exit 1
}

processAllModules


